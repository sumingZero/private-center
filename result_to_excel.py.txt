import json
import pandas as pd
import numpy as np

# Step 1: 读取 JSON 数据
with open('/vllm-workspace/Test_UCM/data.json', 'r', encoding='utf-8') as f:
    data = json.load(f)

# Step 2: 构建 metrics 表（这部分数据单位已经是 ms，无需改动）
metrics_data = {
    "total_input_tokens": data["total_input_tokens"],
    "total_output_tokens": data["total_output_tokens"],
    "request_throughput": data["request_throughput"],
    "request_goodput": data["request_goodput"],
    "output_throughput": data["output_throughput"],
    "total_token_throughput": data["total_token_throughput"],
    "ttft_mean": data["mean_ttft_ms"],
    "ttft_p50": data["p50_ttft_ms"],
    "ttft_p90": data["p90_ttft_ms"],
    "ttft_p99": data["p99_ttft_ms"],
    "tpot_mean": data["mean_tpot_ms"],
    "tpot_p50": data["p50_tpot_ms"],
    "tpot_p90": data["p90_tpot_ms"],
    "tpot_p99": data["p99_tpot_ms"],
    "itl_mean": data["mean_itl_ms"],
    "itl_p50": data["p50_itl_ms"],
    "itl_p90": data["p90_itl_ms"],
    "itl_p99": data["p99_itl_ms"],
    "e2el_mean": data["mean_e2el_ms"],
    "e2el_p50": data["p50_e2el_ms"],
    "e2el_p90": data["p90_e2el_ms"],
    "e2el_p99": data["p99_e2el_ms"],
}

# 转换为 DataFrame（单行）
metrics_df = pd.DataFrame([metrics_data])

# Step 3: 构建 details 表 —— 关键修改在这里
num_requests = len(data["input_lens"])

# 将 ttfts 从秒(s) 转换为毫秒(ms)
ttfts_ms = [t * 1000 for t in data["ttfts"]]

# 将 itls 从秒(s) 转换为毫秒(ms)：先对每个请求的 itl 列表转换单位，再求平均
itls_ms = []
for itl_list in data["itls"]:
    if itl_list:
        # 先将每个值从秒转毫秒，再求平均
        itl_ms_avg = np.mean([x * 1000 for x in itl_list])
        itls_ms.append(itl_ms_avg)
    else:
        itls_ms.append(None)

details_data = {
    "input_lens": data["input_lens"],
    "output_lens": data["output_lens"],
    "ttfts": ttfts_ms,          # 单位：ms
    "itls": itls_ms,            # 单位：ms（每个请求的平均 ITL）
}

details_df = pd.DataFrame(details_data)

# Step 4: 写入 Excel
with pd.ExcelWriter("output.xlsx", engine="openpyxl") as writer:
    metrics_df.to_excel(writer, sheet_name="metrics", index=False)
    details_df.to_excel(writer, sheet_name="details", index=False)

print("✅ 数据已成功写入 output.xlsx")